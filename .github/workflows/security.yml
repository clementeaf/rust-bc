name: Security

on:
  push:
    branches: [main, develop, feature/*, hotfix/*, release/*]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC

jobs:
  secrets-scan:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: TruffleHog secrets scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          debug: true
        continue-on-error: true

  cargo-audit:
    name: Cargo Audit (Rust Dependencies)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.75.0

      - name: Cache Cargo
        uses: actions/cache@v3
        with:
          path: ~/.cargo
          key: ${{ runner.os }}-cargo-audit-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked 2>/dev/null || true

      - name: Run cargo audit
        run: cargo audit 2>&1 | head -50
        continue-on-error: true

      - name: Check Cargo.lock is up-to-date
        run: cargo update --dry-run 2>&1 | head -20
        continue-on-error: true

  dotnet-security:
    name: .NET Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.0'

      - name: Restore packages
        run: dotnet restore
        continue-on-error: true

      - name: Run dotnet list package (check for updates)
        run: dotnet list package --outdated 2>&1 | head -30
        continue-on-error: true

      - name: OWASP Dependency Check
        run: |
          dotnet tool install --global CycloneDX 2>/dev/null || true
          dotnet CycloneDX . -o ./sbom/ 2>&1 | head -20
        continue-on-error: true

  sast-rust:
    name: SAST — Rust Code Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.75.0

      - name: Run clippy (strict)
        run: cargo clippy --all -- -W clippy::all -W clippy::pedantic 2>&1 | grep -E "warning|error" | head -30
        continue-on-error: true

      - name: Check for unsafe code
        run: |
          echo "Checking for unsafe blocks:"
          grep -r "unsafe" src/ | wc -l
          echo "Unsafe blocks found above. Review for necessity."
        continue-on-error: true

  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [secrets-scan, cargo-audit, dotnet-security, sast-rust]
    if: always()
    steps:
      - name: Check security scan results
        run: |
          echo "Secrets Scan: ${{ needs.secrets-scan.result }}"
          echo "Cargo Audit: ${{ needs.cargo-audit.result }}"
          echo ".NET Security: ${{ needs.dotnet-security.result }}"
          echo "SAST (Rust): ${{ needs.sast-rust.result }}"
          
          FAILED=0
          if [ "${{ needs.secrets-scan.result }}" = "failure" ]; then
            echo "❌ SECRETS FOUND — DO NOT COMMIT"
            FAILED=1
          fi
          if [ "${{ needs.cargo-audit.result }}" = "failure" ]; then
            echo "⚠️ Cargo audit issues — review dependencies"
          fi
          
          if [ $FAILED -eq 1 ]; then
            exit 1
          fi
          echo "✅ Security scans complete"
