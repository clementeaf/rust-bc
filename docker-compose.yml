version: '3.8'

services:
  # Nodo principal (bootstrap)
  node1:
    build: .
    container_name: rust-bc-node1
    ports:
      - "8080:8080"  # API
      - "8081:8081"  # P2P
    environment:
      - API_PORT=8080
      - P2P_PORT=8081
      - DB_NAME=blockchain
      - DIFFICULTY=1
      - RUST_LOG=info
    volumes:
      - node1-data:/app/data
    networks:
      - blockchain-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Nodo secundario
  node2:
    build: .
    container_name: rust-bc-node2
    ports:
      - "8082:8080"  # API
      - "8083:8081"  # P2P
    environment:
      - API_PORT=8080
      - P2P_PORT=8081
      - DB_NAME=blockchain
      - DIFFICULTY=1
      - RUST_LOG=info
    volumes:
      - node2-data:/app/data
    networks:
      - blockchain-network
    restart: unless-stopped
    depends_on:
      - node1
    command: ["8080", "8081", "blockchain"]
    # Conectar a node1 despu√©s de iniciar
    entrypoint: ["/bin/bash", "-c", "sleep 5 && rust-bc 8080 8081 blockchain"]

  # Nodo terciario
  node3:
    build: .
    container_name: rust-bc-node3
    ports:
      - "8084:8080"  # API
      - "8085:8081"  # P2P
    environment:
      - API_PORT=8080
      - P2P_PORT=8081
      - DB_NAME=blockchain
      - DIFFICULTY=1
      - RUST_LOG=info
    volumes:
      - node3-data:/app/data
    networks:
      - blockchain-network
    restart: unless-stopped
    depends_on:
      - node1
      - node2
    command: ["8080", "8081", "blockchain"]

volumes:
  node1-data:
    driver: local
  node2-data:
    driver: local
  node3-data:
    driver: local

networks:
  blockchain-network:
    driver: bridge

